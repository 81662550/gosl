// Copyright 2016 The Gosl Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file.

package msh

import (
	"math"

	"github.com/cpmech/gosl/num"
	"github.com/cpmech/gosl/plt"
	"github.com/cpmech/gosl/utl"
)

// QuadPointsGaussLegendre generate quadrature points for Gauss-Legendre integration
//    npts -- is the total number of points; e.g. 27 for 3D (boxes)
func QuadPointsGaussLegendre(ndim, npts int) (pts [][]float64) {
	n1d := int(math.Floor(math.Pow(float64(npts), 1.0/float64(ndim)) + 0.5))
	x, w := num.GaussLegendreXW(-1, 1, n1d)
	pts = make([][]float64, npts)
	switch ndim {
	case 1:
		for i := 0; i < npts; i++ {
			pts[i] = []float64{x[i], 0, 0, w[i]}
		}
	case 2:
		for j := 0; j < n1d; j++ {
			for i := 0; i < n1d; i++ {
				m := i + n1d*j
				pts[m] = []float64{x[i], x[j], 0, w[i] * w[j]}
			}
		}
	case 3:
		for k := 0; k < n1d; k++ {
			for j := 0; j < n1d; j++ {
				for i := 0; i < n1d; i++ {
					m := i + n1d*j + (n1d*n1d)*k
					pts[m] = []float64{x[i], x[j], x[k], w[i] * w[j] * w[k]}
				}
			}
		}
	}
	return
}

// QuadPointsWilson5 generates 5 integration points according to Wilson's Appendix G-7 formulae
//    w0input  -- if w0input > 0, use this value instead of default w0=8/3 (corner)
//    p4stable -- if true, use w0=0.004 and wa=0.999 to mimic 4-point rule
func QuadPointsWilson5(w0input float64, p4stable bool) (pts [][]float64) {
	w0 := 8.0 / 3.0
	wa := 1.0 / 3.0
	a := 1.0
	if w0input > 0 {
		w0 = w0input
		wa = (4.0 - w0) / 4.0
		a = math.Sqrt(1.0 / (3.0 * wa))
	}
	if p4stable {
		w0 = 0.004
		wa = 0.999
		a = 0.5776391
	}
	return [][]float64{
		{-a, -a, 0, wa},
		{+a, -a, 0, wa},
		{+0, +0, 0, w0},
		{-a, +a, 0, wa},
		{+a, +a, 0, wa},
	}
}

// QuadPointsWilson8 generates 8 integration points according to Wilson's Appendix G-7 formulae
//    wbinput -- if wbinput > 0, use this value instead of default wb=40/49
func QuadPointsWilson8(wbinput float64) (pts [][]float64) {
	a := math.Sqrt(7.0 / 9.0)
	b := math.Sqrt(7.0 / 15.0)
	wa := 9.0 / 49.0
	wb := 40.0 / 49.0
	if wbinput > 0 {
		wb = wbinput
		wa = 1.0 - wb
		swa := math.Sqrt(wa)
		a = 1.0 / math.Sqrt(3.0*swa)
		b = math.Sqrt((2.0 - 2.0*swa) / (3.0 * wb))
	}
	return [][]float64{
		{-a, -a, 0, wa},
		{+0, -b, 0, wb},
		{+a, -a, 0, wa},
		{-b, +0, 0, wb},
		{+b, +0, 0, wb},
		{-a, +a, 0, wa},
		{+0, +b, 0, wb},
		{+a, +a, 0, wa},
	}
	return
}

// QuadPointDraw draws quadrature point within standard rectangle or box
//   dx -- can be used to displace box; may be nil
func QuadPointDraw(pts [][]float64, ndim int, triOrTet bool, dx []float64, args *plt.A) {
	if args == nil {
		args = &plt.A{C: "r", M: "*", Mec: "r", NoClip: true}
	}
	if dx == nil {
		dx = []float64{0, 0, 0}
	}
	if ndim == 2 {
		argsPoly := &plt.A{Fc: "none", Ec: "#2645cb", Closed: true, NoClip: true}
		if triOrTet {
			plt.Polyline([][]float64{
				{dx[0], dx[1]}, {dx[0] + 1, dx[1]}, {dx[0] + 0, dx[1] + 1},
			}, argsPoly)
		} else {
			plt.Polyline([][]float64{
				{dx[0] - 1, dx[1] - 1}, {dx[0] + 1, dx[1] - 1}, {dx[0] + 1, dx[1] + 1}, {dx[0] - 1, dx[1] + 1},
			}, argsPoly)
		}
		for _, p := range pts {
			plt.PlotOne(dx[0]+p[0], dx[1]+p[1], args)
		}
	}
}

/// map of integration points //////////////////////////////////////////////////////////////////////

var IntPoints = make(map[string]map[string][][]float64)

// constants
func init() {

	IntPoints["lin"] = map[string][][]float64{
		"legendre_1": [][]float64{
			{0, 0, 0, 2},
		},
		"legendre_2": [][]float64{
			{-0.5773502691896257, 0, 0, 1},
			{+0.5773502691896257, 0, 0, 1},
		},
		"legendre_3": [][]float64{
			{-0.7745966692414834, 0, 0, 0.5555555555555556},
			{+0.0000000000000000, 0, 0, 0.8888888888888888},
			{+0.7745966692414834, 0, 0, 0.5555555555555556},
		},
		"legendre_4": [][]float64{
			{-0.8611363115940526, 0, 0, 0.3478548451374538},
			{-0.3399810435848562, 0, 0, 0.6521451548625462},
			{+0.3399810435848562, 0, 0, 0.6521451548625462},
			{+0.8611363115940526, 0, 0, 0.3478548451374538},
		},
		"legendre_5": [][]float64{
			{-0.9061798459386640, 0, 0, 0.2369268850561891},
			{-0.5384693101056831, 0, 0, 0.4786286704993665},
			{+0.0000000000000000, 0, 0, 0.5688888888888889},
			{+0.5384693101056831, 0, 0, 0.4786286704993665},
			{+0.9061798459386640, 0, 0, 0.2369268850561891},
		},
	}

	IntPoints["qua"] = map[string][][]float64{
		"legendre_4": [][]float64{
			{-0.5773502691896257, -0.5773502691896257, 0, 1},
			{+0.5773502691896257, -0.5773502691896257, 0, 1},
			{-0.5773502691896257, +0.5773502691896257, 0, 1},
			{+0.5773502691896257, +0.5773502691896257, 0, 1},
		},
		"legendre_9": [][]float64{
			{-0.7745966692414834, -0.7745966692414834, 0, 25.0 / 81.0},
			{+0.0000000000000000, -0.7745966692414834, 0, 40.0 / 81.0},
			{+0.7745966692414834, -0.7745966692414834, 0, 25.0 / 81.0},
			{-0.7745966692414834, +0.0000000000000000, 0, 40.0 / 81.0},
			{+0.0000000000000000, +0.0000000000000000, 0, 64.0 / 81.0},
			{+0.7745966692414834, +0.0000000000000000, 0, 40.0 / 81.0},
			{-0.7745966692414834, +0.7745966692414834, 0, 25.0 / 81.0},
			{+0.0000000000000000, +0.7745966692414834, 0, 40.0 / 81.0},
			{+0.7745966692414834, +0.7745966692414834, 0, 25.0 / 81.0},
		},
		"wilson5corner_5":  QuadPointsWilson5(0, false),
		"wilson5stable_5":  QuadPointsWilson5(0, true),
		"wilson8default_8": QuadPointsWilson8(0),
	}

	SQ19by30 := math.Sqrt(19.0 / 30.0)
	SQ19by33 := math.Sqrt(19.0 / 33.0)

	IntPoints["hex"] = map[string][][]float64{
		"legendre_8": [][]float64{
			{-0.5773502691896257, -0.5773502691896257, -0.5773502691896257, 1},
			{+0.5773502691896257, -0.5773502691896257, -0.5773502691896257, 1},
			{-0.5773502691896257, +0.5773502691896257, -0.5773502691896257, 1},
			{+0.5773502691896257, +0.5773502691896257, -0.5773502691896257, 1},
			{-0.5773502691896257, -0.5773502691896257, +0.5773502691896257, 1},
			{+0.5773502691896257, -0.5773502691896257, +0.5773502691896257, 1},
			{-0.5773502691896257, +0.5773502691896257, +0.5773502691896257, 1},
			{+0.5773502691896257, +0.5773502691896257, +0.5773502691896257, 1},
		},
		"irons_14": [][]float64{
			{+SQ19by30, 0.0, 0.0, 320.0 / 361.0},
			{-SQ19by30, 0.0, 0.0, 320.0 / 361.0},
			{0.0, +SQ19by30, 0.0, 320.0 / 361.0},
			{0.0, -SQ19by30, 0.0, 320.0 / 361.0},
			{0.0, 0.0, +SQ19by30, 320.0 / 361.0},
			{0.0, 0.0, -SQ19by30, 320.0 / 361.0},
			{+SQ19by33, +SQ19by33, +SQ19by33, 121.0 / 361.0},
			{-SQ19by33, +SQ19by33, +SQ19by33, 121.0 / 361.0},
			{+SQ19by33, -SQ19by33, +SQ19by33, 121.0 / 361.0},
			{-SQ19by33, -SQ19by33, +SQ19by33, 121.0 / 361.0},
			{+SQ19by33, +SQ19by33, -SQ19by33, 121.0 / 361.0},
			{-SQ19by33, +SQ19by33, -SQ19by33, 121.0 / 361.0},
			{+SQ19by33, -SQ19by33, -SQ19by33, 121.0 / 361.0},
			{-SQ19by33, -SQ19by33, -SQ19by33, 121.0 / 361.0},
		},
		"legendre_27": [][]float64{
			{-0.774596669241483, -0.774596669241483, -0.774596669241483, 0.171467764060357},
			{+0.000000000000000, -0.774596669241483, -0.774596669241483, 0.274348422496571},
			{+0.774596669241483, -0.774596669241483, -0.774596669241483, 0.171467764060357},
			{-0.774596669241483, +0.000000000000000, -0.774596669241483, 0.274348422496571},
			{+0.000000000000000, +0.000000000000000, -0.774596669241483, 0.438957475994513},
			{+0.774596669241483, +0.000000000000000, -0.774596669241483, 0.274348422496571},
			{-0.774596669241483, +0.774596669241483, -0.774596669241483, 0.171467764060357},
			{+0.000000000000000, +0.774596669241483, -0.774596669241483, 0.274348422496571},
			{+0.774596669241483, +0.774596669241483, -0.774596669241483, 0.171467764060357},
			{-0.774596669241483, -0.774596669241483, +0.000000000000000, 0.274348422496571},
			{+0.000000000000000, -0.774596669241483, +0.000000000000000, 0.438957475994513},
			{+0.774596669241483, -0.774596669241483, +0.000000000000000, 0.274348422496571},
			{-0.774596669241483, +0.000000000000000, +0.000000000000000, 0.438957475994513},
			{+0.000000000000000, +0.000000000000000, +0.000000000000000, 0.702331961591221},
			{+0.774596669241483, +0.000000000000000, +0.000000000000000, 0.438957475994513},
			{-0.774596669241483, +0.774596669241483, +0.000000000000000, 0.274348422496571},
			{+0.000000000000000, +0.774596669241483, +0.000000000000000, 0.438957475994513},
			{+0.774596669241483, +0.774596669241483, +0.000000000000000, 0.274348422496571},
			{-0.774596669241483, -0.774596669241483, +0.774596669241483, 0.171467764060357},
			{+0.000000000000000, -0.774596669241483, +0.774596669241483, 0.274348422496571},
			{+0.774596669241483, -0.774596669241483, +0.774596669241483, 0.171467764060357},
			{-0.774596669241483, +0.000000000000000, +0.774596669241483, 0.274348422496571},
			{+0.000000000000000, +0.000000000000000, +0.774596669241483, 0.438957475994513},
			{+0.774596669241483, +0.000000000000000, +0.774596669241483, 0.274348422496571},
			{-0.774596669241483, +0.774596669241483, +0.774596669241483, 0.171467764060357},
			{+0.000000000000000, +0.774596669241483, +0.774596669241483, 0.274348422496571},
			{+0.774596669241483, +0.774596669241483, +0.774596669241483, 0.171467764060357},
		},
	}

	IntPoints["tri"] = map[string][][]float64{
		"internal_1": [][]float64{
			{1.0 / 3.0, 1.0 / 3.0, 0, 1.0 / 2.0},
		},
		"internal_3": [][]float64{
			{1.0 / 6.0, 1.0 / 6.0, 0, 1.0 / 6.0},
			{2.0 / 3.0, 1.0 / 6.0, 0, 1.0 / 6.0},
			{1.0 / 6.0, 2.0 / 3.0, 0, 1.0 / 6.0},
		},
		"edge_3": [][]float64{
			{0.5, 0.5, 0, 1.0 / 6.0},
			{0.0, 0.5, 0, 1.0 / 6.0},
			{0.5, 0.0, 0, 1.0 / 6.0},
		},
		"internal_4": [][]float64{
			{1.0 / 3.0, 1.0 / 3.0, 0, -27.0 / 96.0},
			{1.0 / 5.0, 1.0 / 5.0, 0, +25.0 / 96.0},
			{3.0 / 5.0, 1.0 / 5.0, 0, +25.0 / 96.0},
			{1.0 / 5.0, 3.0 / 5.0, 0, +25.0 / 96.0},
		},
		"internal_12": [][]float64{
			{0.873821971016996, 0.063089014491502, 0, 0.0254224531851035},
			{0.063089014491502, 0.873821971016996, 0, 0.0254224531851035},
			{0.063089014491502, 0.063089014491502, 0, 0.0254224531851035},
			{0.501426509658179, 0.249286745170910, 0, 0.0583931378631895},
			{0.249286745170910, 0.501426509658179, 0, 0.0583931378631895},
			{0.249286745170910, 0.249286745170910, 0, 0.0583931378631895},
			{0.053145049844817, 0.310352451033784, 0, 0.041425537809187},
			{0.310352451033784, 0.053145049844817, 0, 0.041425537809187},
			{0.053145049844817, 0.636502499121398, 0, 0.041425537809187},
			{0.310352451033784, 0.636502499121398, 0, 0.041425537809187},
			{0.636502499121398, 0.053145049844817, 0, 0.041425537809187},
			{0.636502499121398, 0.310352451033784, 0, 0.041425537809187},
		},
		"internal_16": [][]float64{
			{3.33333333333333E-01, 3.33333333333333E-01, 0, 7.21578038388935E-02},
			{8.14148234145540E-02, 4.59292588292723E-01, 0, 4.75458171336425E-02},
			{4.59292588292723E-01, 8.14148234145540E-02, 0, 4.75458171336425E-02},
			{4.59292588292723E-01, 4.59292588292723E-01, 0, 4.75458171336425E-02},
			{6.58861384496480E-01, 1.70569307751760E-01, 0, 5.16086852673590E-02},
			{1.70569307751760E-01, 6.58861384496480E-01, 0, 5.16086852673590E-02},
			{1.70569307751760E-01, 1.70569307751760E-01, 0, 5.16086852673590E-02},
			{8.98905543365938E-01, 5.05472283170310E-02, 0, 1.62292488115990E-02},
			{5.05472283170310E-02, 8.98905543365938E-01, 0, 1.62292488115990E-02},
			{5.05472283170310E-02, 5.05472283170310E-02, 0, 1.62292488115990E-02},
			{8.39477740995800E-03, 2.63112829634638E-01, 0, 1.36151570872175E-02},
			{7.28492392955404E-01, 8.39477740995800E-03, 0, 1.36151570872175E-02},
			{2.63112829634638E-01, 7.28492392955404E-01, 0, 1.36151570872175E-02},
			{8.39477740995800E-03, 7.28492392955404E-01, 0, 1.36151570872175E-02},
			{7.28492392955404E-01, 2.63112829634638E-01, 0, 1.36151570872175E-02},
			{2.63112829634638E-01, 8.39477740995800E-03, 0, 1.36151570872175E-02},
		},
	}

	IntPoints["tet"] = map[string][][]float64{
		"internal_1": [][]float64{
			{1.0 / 4.0, 1.0 / 4.0, 1.0 / 4.0, 1.0 / 6.0},
		},
		"internal_4": [][]float64{
			{(5.0 + 3.0*utl.SQ5) / 20.0, (5.0 - utl.SQ5) / 20.0, (5.0 - utl.SQ5) / 20.0, 1.0 / 24},
			{(5.0 - utl.SQ5) / 20.0, (5.0 + 3.0*utl.SQ5) / 20.0, (5.0 - utl.SQ5) / 20.0, 1.0 / 24},
			{(5.0 - utl.SQ5) / 20.0, (5.0 - utl.SQ5) / 20.0, (5.0 + 3.0*utl.SQ5) / 20.0, 1.0 / 24},
			{(5.0 - utl.SQ5) / 20.0, (5.0 - utl.SQ5) / 20.0, (5.0 - utl.SQ5) / 20.0, 1.0 / 24},
		},
		"internal_5": [][]float64{
			{1.0 / 4.0, 1.0 / 4.0, 1.0 / 4.0, -2.0 / 15.0},
			{1.0 / 6.0, 1.0 / 6.0, 1.0 / 6.0, +3.0 / 40.0},
			{1.0 / 6.0, 1.0 / 6.0, 1.0 / 2.0, +3.0 / 40.0},
			{1.0 / 6.0, 1.0 / 2.0, 1.0 / 6.0, +3.0 / 40.0},
			{1.0 / 2.0, 1.0 / 6.0, 1.0 / 6.0, +3.0 / 40.0},
		},
		"internal_6": [][]float64{
			{+1.0, +0.0, +0.0, 4.0 / 3.0},
			{-1.0, +0.0, +0.0, 4.0 / 3.0},
			{+0.0, +1.0, +0.0, 4.0 / 3.0},
			{+0.0, -1.0, +0.0, 4.0 / 3.0},
			{+0.0, +0.0, +1.0, 4.0 / 3.0},
			{+0.0, +0.0, -1.0, 4.0 / 3.0},
		},
	}
}
